# /ctx — Project Context Understanding PRO
# Usage: /ctx [all | arch | deps | debt | update | quick]
# Default: all

Perform a structured project context analysis. Mode: "$ARGUMENTS" (empty = "all").

---

## ⚡ Step 0: Pre-Flight (always first)

Determine mode from "$ARGUMENTS":
- Empty or "all"    → Full analysis (~10-15k tokens)
- "arch"            → Architecture only (~4k tokens)
- "deps"            → Dependencies + risks only (~3k tokens)
- "debt"            → Tech debt scan only (~3k tokens)
- "update"          → Refresh existing map from recent git changes (~3k tokens)
- "quick"           → Structure + classification only, no file reads (~2k tokens)

Check if `PROJECT_CONTEXT_MAP.md` exists in project root:
- EXISTS → Load first 20 lines to understand last analysis date. If mode="update", do incremental only.
- MISSING → Full scan required regardless of mode.

**Token budget check:** Estimate cost for selected mode. If >10k tokens needed but daily budget is low, warn user and suggest "quick" or "update" mode.

---

## Phase 1: Structure Scan
(~1-2k tokens | Glob only — NO file reads yet)

Run these Glob patterns **in parallel**:
1. Top-level: `*` (root files only)
2. Source: `src/**/*` AND `lib/**/*` AND `app/**/*`
3. Config: `**/*.json` (exclude node_modules, max 15 results)
4. Bin/Scripts: `bin/**/*` AND `scripts/**/*`
5. AI Framework: `.ai/**/*` AND `.claude/**/*`
6. Templates: `npm-templates/**/*` (if exists)
7. Docs: `**/*.md` (exclude node_modules, max 10 results)

**From structure, detect project type:**
- Has `.ai/` directory → AI Framework project (ai-workflow-rules pattern)
- Has `npm-templates/` → Dual-structure (source + distributable)
- Has `bin/` + `package.json` → CLI tool
- Has `src/` + framework files → Web/API app
- Has multiple `package.json` → Monorepo

**Count:** total source files, config files, test files, doc files.

Report: `"Structure: X files in Y dirs. Type: [detected]. Key dirs: [list]"`

---

## Phase 2: Selective Intelligence
(~5-8k tokens | Targeted reads only)

**SKIP Phase 2 for modes: "quick"**

Read these files **in parallel** (skip if missing or >200 lines — use limit parameter):

| File | Lines to read | Purpose |
|------|--------------|---------|
| `package.json` | all (usually short) | Name, version, scripts, deps |
| `QUICK_CONTEXT.md` | first 30 lines | Quick project rules summary |
| `ROADMAP.md` | first 60 lines | Current phase + next steps |
| `CHANGELOG.md` | first 40 lines | Recent changes |
| `README.md` | first 50 lines | Project description |
| `.ai/config.json` | all | AI framework config |

**NEVER read:** `node_modules/`, `dist/`, `build/`, `.git/`, lock files, `token-limits.json` (840+ lines = too large).

**For AI Framework projects:** Also read `.ai/AI-ENFORCEMENT.md` lines 1-50 to understand active protocols.

---

## Phase 3: Architecture Modeling
(Reasoning only, no additional reads)

**SKIP Phase 3 for modes: "quick", "deps", "debt"**

From what you found, determine:

**Architecture Pattern:**
- Root-level scripts/configs only → Tool/Script project
- `src/` with clear layer dirs → Layered architecture
- Feature-based dirs → Modular
- Multiple packages → Monorepo
- `.ai/` + context system → AI Framework (special pattern)

**Complexity Score (1-10):**
- File count: <20=1, 20-50=2, 50-100=4, 100-200=6, 200+=8
- +1 if no tests detected
- +1 if no documentation
- +1 if many large files (>300 lines)
- Cap at 10

**Health Signals (check for):**
- ✅ GOOD: Has README, has tests, clear structure, CHANGELOG present
- ⚠️ WARN: Large files >500 lines, mixed concerns, missing docs
- ❌ BAD: No README, no tests, circular-looking dependencies

---

## Phase 4: Write Context Map
(Write to `PROJECT_CONTEXT_MAP.md` in project root)

**SKIP writing for modes: "quick", "arch", "deps", "debt"** — show output only, don't write.

Write or update `PROJECT_CONTEXT_MAP.md`:

```markdown
# PROJECT CONTEXT MAP
> Auto-generated by `/ctx`. Update with `/ctx update`. Do not edit manually.

**Last Updated:** [TODAY'S DATE]
**Analysis Mode:** [full/incremental]
**Token Cost:** ~Xk tokens

---

## Classification
- **Type:** [CLI Tool | Web App | API | AI Framework | Library | Monorepo | Script]
- **Architecture:** [Layered | Modular | Monorepo | Flat | AI Framework]
- **Language:** [primary language]
- **Version:** [from package.json if available]
- **Complexity:** [Low/Medium/High] ([score]/10)

---

## What This Project Does
[1-2 sentences from README/package.json description. If unclear, state "Description not found in README."]

---

## Key Files (read these first for any task)
| File | Purpose | Size |
|------|---------|------|
| [file] | [what it does] | [short/medium/large] |

Limit to top 8 most important files.

---

## Entry Points
[Main entry points with their purpose. E.g., "bin/cli.js → CLI entry point"]

---

## Current State
[From ROADMAP.md or CHANGELOG.md: what phase/version is active, what's in progress]
If no ROADMAP found: "No ROADMAP detected. Check CHANGELOG for current state."

---

## Architecture Notes
[Pattern, any violations, notable design decisions found during analysis]

---

## Dependencies
**Core:** [top 5 from package.json/requirements.txt]
**Dev:** [top 3 dev dependencies]
**⚠️ Flags:** [any obviously outdated or risky packages]
If no package file found: "No dependency file detected."

---

## Technical Debt
[List only items actually found during scan:]
- ⚠️ Large files (>300 lines): [list with line counts]
- ⚠️ Missing: [tests/docs/README as applicable]
- ✅ [any positive signals]

---

## AI Framework Protocols (if applicable)
[Only include if .ai/ directory detected]
- Active context: [from .ai/config.json]
- Key rules file: [location]
- Token limit config: [location]

---

## Recommended Entry Points for Common Tasks
| Task Type | Start Here |
|-----------|-----------|
| Understanding the project | README.md → QUICK_CONTEXT.md |
| Current work | ROADMAP.md |
| Adding features | [main source dir] |
| Checking rules | .ai/rules/core.md |
```

---

## Phase 5: Done Report

Always show this at the end:

```
[CTX COMPLETE] ─────────────────────────────
Mode:      [full/arch/deps/debt/update/quick]
Scanned:   X files via Glob
Read:      Y files
Written:   PROJECT_CONTEXT_MAP.md ✓ (or "not written" for quick modes)
Tokens:    ~Zk for this analysis

Key insight: [1 most important thing to know about this project right now]

Context loaded. Ready for tasks.
─────────────────────────────────────────────
```

---

## Special: Incremental Update Mode (`/ctx update`)

When mode = "update":
1. Read existing `PROJECT_CONTEXT_MAP.md` (full)
2. Run `git log --oneline -10` to see recent changes
3. Run `git diff --name-only HEAD~5 HEAD` to see changed files
4. Read ONLY the changed files (targeted)
5. Update only the relevant sections of the map
6. Note: "Updated X sections based on Y recent commits"

Cost: ~3-4k tokens instead of 10-15k for full scan.

---

## Notes on Limitations (be honest with user if asked)

This skill does NOT support:
- Auto-triggering on file changes (not supported in Claude Code)
- Background monitoring
- Real-time architecture drift detection
- VSCode integration beyond standard Claude Code

What it DOES support:
- Manual invocation at any time: `/ctx`
- Incremental updates: `/ctx update`
- Focused scans: `/ctx deps`, `/ctx debt`, `/ctx arch`
- Persistent map in `PROJECT_CONTEXT_MAP.md` for cheap future reference
