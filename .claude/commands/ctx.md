# /ctx â€” Project Context Understanding PRO
# Usage: /ctx [all | arch | deps | debt | update | quick | ideology]
# Default: all

Perform a structured project context analysis. Mode: "$ARGUMENTS" (empty = "all").

---

## âš¡ Step 0: Pre-Flight (always first)

Determine mode from "$ARGUMENTS":
- Empty or "all"    â†’ Full analysis (~10-15k tokens)
- "arch"            â†’ Architecture only (~4k tokens)
- "deps"            â†’ Dependencies + risks only (~3k tokens)
- "debt"            â†’ Tech debt scan only (~3k tokens)
- "update"          â†’ Refresh existing map from recent git changes (~3k tokens)
- "quick"           â†’ Structure + classification only, no file reads (~2k tokens)
- "ideology"        â†’ PROJECT_IDEOLOGY.md only â€” capture/update project WHY (~3k tokens)

Check if `PROJECT_CONTEXT_MAP.md` exists in project root:
- EXISTS â†’ Load first 20 lines to understand last analysis date. If mode="update", do incremental only.
- MISSING â†’ Full scan required regardless of mode.

**Token budget check:** Estimate cost for selected mode. If >10k tokens needed but daily budget is low, warn user and suggest "quick" or "update" mode.

---

## Phase 1: Structure Scan
(~1-2k tokens | Glob only â€” NO file reads yet)

Run these Glob patterns **in parallel**:
1. Top-level: `*` (root files only)
2. Source: `src/**/*` AND `lib/**/*` AND `app/**/*`
3. Config: `**/*.json` (exclude node_modules, max 15 results)
4. Bin/Scripts: `bin/**/*` AND `scripts/**/*`
5. AI Framework: `.ai/**/*` AND `.claude/**/*`
6. Templates: `npm-templates/**/*` (if exists)
7. Docs: `**/*.md` (exclude node_modules, max 10 results)

**From structure, detect project type:**
- Has `.ai/` directory â†’ AI Framework project (ai-workflow-rules pattern)
- Has `npm-templates/` â†’ Dual-structure (source + distributable)
- Has `bin/` + `package.json` â†’ CLI tool
- Has `src/` + framework files â†’ Web/API app
- Has multiple `package.json` â†’ Monorepo

**Count:** total source files, config files, test files, doc files.

Report: `"Structure: X files in Y dirs. Type: [detected]. Key dirs: [list]"`

---

## Phase 2: Selective Intelligence
(~5-8k tokens | Targeted reads only)

**SKIP Phase 2 for modes: "quick"**

Read these files **in parallel** (skip if missing or >200 lines â€” use limit parameter):

| File | Lines to read | Purpose |
|------|--------------|---------|
| `package.json` | all (usually short) | Name, version, scripts, deps |
| `QUICK_CONTEXT.md` | first 30 lines | Quick project rules summary |
| `ROADMAP.md` | first 60 lines | Current phase + next steps |
| `CHANGELOG.md` | first 40 lines | Recent changes |
| `README.md` | first 50 lines | Project description |
| `.ai/config.json` | all | AI framework config |

**NEVER read:** `node_modules/`, `dist/`, `build/`, `.git/`, lock files, `token-limits.json` (840+ lines = too large).

**For AI Framework projects:** Also read `.ai/AI-ENFORCEMENT.md` lines 1-50 to understand active protocols.

---

## Phase 3: Architecture Modeling
(Reasoning only, no additional reads)

**SKIP Phase 3 for modes: "quick", "deps", "debt"**

From what you found, determine:

**Architecture Pattern:**
- Root-level scripts/configs only â†’ Tool/Script project
- `src/` with clear layer dirs â†’ Layered architecture
- Feature-based dirs â†’ Modular
- Multiple packages â†’ Monorepo
- `.ai/` + context system â†’ AI Framework (special pattern)

**Complexity Score (1-10):**
- File count: <20=1, 20-50=2, 50-100=4, 100-200=6, 200+=8
- +1 if no tests detected
- +1 if no documentation
- +1 if many large files (>300 lines)
- Cap at 10

**Health Signals (check for):**
- âœ… GOOD: Has README, has tests, clear structure, CHANGELOG present
- âš ï¸ WARN: Large files >500 lines, mixed concerns, missing docs
- âŒ BAD: No README, no tests, circular-looking dependencies

---

## Phase 4: Write Context Map
(Write to `PROJECT_CONTEXT_MAP.md` in project root)

**SKIP writing for modes: "quick", "arch", "deps", "debt"** â€” show output only, don't write.

Write or update `PROJECT_CONTEXT_MAP.md`:

```markdown
# PROJECT CONTEXT MAP
> Auto-generated by `/ctx`. Update with `/ctx update`. Do not edit manually.

**Last Updated:** [TODAY'S DATE]
**Analysis Mode:** [full/incremental]
**Token Cost:** ~Xk tokens

---

## Classification
- **Type:** [CLI Tool | Web App | API | AI Framework | Library | Monorepo | Script]
- **Architecture:** [Layered | Modular | Monorepo | Flat | AI Framework]
- **Language:** [primary language]
- **Version:** [from package.json if available]
- **Complexity:** [Low/Medium/High] ([score]/10)

---

## What This Project Does
[1-2 sentences from README/package.json description. If unclear, state "Description not found in README."]

---

## Key Files (read these first for any task)
| File | Purpose | Size |
|------|---------|------|
| [file] | [what it does] | [short/medium/large] |

Limit to top 8 most important files.

---

## Entry Points
[Main entry points with their purpose. E.g., "bin/cli.js â†’ CLI entry point"]

---

## Current State
[From ROADMAP.md or CHANGELOG.md: what phase/version is active, what's in progress]
If no ROADMAP found: "No ROADMAP detected. Check CHANGELOG for current state."

---

## Architecture Notes
[Pattern, any violations, notable design decisions found during analysis]

---

## Dependencies
**Core:** [top 5 from package.json/requirements.txt]
**Dev:** [top 3 dev dependencies]
**âš ï¸ Flags:** [any obviously outdated or risky packages]
If no package file found: "No dependency file detected."

---

## Technical Debt
[List only items actually found during scan:]
- âš ï¸ Large files (>300 lines): [list with line counts]
- âš ï¸ Missing: [tests/docs/README as applicable]
- âœ… [any positive signals]

---

## AI Framework Protocols (if applicable)
[Only include if .ai/ directory detected]
- Active context: [from .ai/config.json]
- Key rules file: [location]
- Token limit config: [location]

---

## Recommended Entry Points for Common Tasks
| Task Type | Start Here |
|-----------|-----------|
| Understanding the project | README.md â†’ QUICK_CONTEXT.md |
| Current work | ROADMAP.md |
| Adding features | [main source dir] |
| Checking rules | .ai/rules/core.md |

---

## ğŸ“ Last Push
| Field | Value |
|-------|-------|
| Date  | [YYYY-MM-DD] |
| Commit | [hash] |
| Message | [commit message] |
```

---

## Phase 5: Ideology Capture
(Write to `PROJECT_IDEOLOGY.md` in project root â€” append-only after first creation)

**SKIP for modes: "quick", "arch", "deps", "debt", "update"**
**ALWAYS run for modes: "all", "ideology"**

### Step 5.1: WebSearch for Context (mandatory)

Before writing ideology, use WebSearch to understand the current landscape:

Search for: `"[project_name OR primary_tool] best practices 2026"`

Use results to inform the VISION and PRINCIPLES sections â€” cite what you found vs. what was already known.
Mark any unverified claims as [ESTIMATE].

### Step 5.2: Check existing PROJECT_IDEOLOGY.md

**If MISSING (first run):** â†’ Case A below.
**If EXISTS:** â†’ Case B below.

---

### Case A: First run â€” Create PROJECT_IDEOLOGY.md

Think deeply before writing. This document captures the soul of the project â€” not just what it does, but WHY it exists, WHO it serves, and WHAT it refuses to become.

Write `PROJECT_IDEOLOGY.md` to project root:

```markdown
# PROJECT IDEOLOGY
> Created by `/ctx` on [DATE].
> Append-only. Update with `/ctx update` or `/ctx ideology` â€” never overwrite.
> This document captures WHY the project exists and the decisions that define it.

---

## [v1.0] [DATE] â€” Initial Ideology Capture

### WHY â€” Core Purpose
[1-3 sentences: the fundamental problem this project solves.
NOT what it does mechanically â€” WHY it matters to the people who use it.]

### WHO â€” Primary User
[Describe the primary user in 2-3 sentences.
Their context, their pain, what they need. Be specific â€” not "developers" but what kind.]

### PRINCIPLES â€” Non-Negotiable Rules
[List 3-6 principles that the project will NEVER violate.
Examples: "Quality > Speed", "No Russian services", "Opinionated by default"]

### ANTI-GOALS â€” What This Project Is NOT
[List 3-5 things this project explicitly refuses to be.
Examples: "Not a generic tool", "Not opt-in everything", "Not enterprise-first"]

### DECISIONS â€” Architectural Choices Locked In
[List key decisions that were made and WHY. Format:
- Decision: [what was decided]
  Rationale: [why â€” the tradeoff considered]
  Alternatives rejected: [what was not chosen]]

### VISION â€” Where This Is Going (2026+)
[1-3 sentences: what does this project look like when it's "done"?
What would make the creator say "yes, this is exactly what I wanted"?]

### MARKET CONTEXT (from WebSearch [DATE])
[Brief summary of what the industry looks like for this type of project.
What competitors/alternatives exist. Why this approach is distinct.
Source: [search query used]]
```

---

### Case B: Subsequent run â€” Append delta to PROJECT_IDEOLOGY.md

Read the existing `PROJECT_IDEOLOGY.md` (first 30 lines to check last version).

Think: what has changed since the last entry? Check:
- Recent ROADMAP.md changes (what decisions were made?)
- Recent git log (what was built/removed?)
- Any architectural shifts visible in PROJECT_CONTEXT_MAP.md

If nothing meaningful changed â†’ do NOT append. Show:
```
â„¹ï¸ PROJECT_IDEOLOGY.md: no significant changes detected. Skipping append.
   Last entry: [date] [version]
```

If changes detected â†’ append this section to `PROJECT_IDEOLOGY.md`:

```markdown

---

## [vX.Y] [DATE] â€” Logic Delta

### What Changed
[2-4 bullet points: decisions made since last ideology entry]

### Why It Matters
[1-2 sentences: how these decisions reinforce or adjust the project's direction]

### Updated Market Context (from WebSearch [DATE])
[Any new market developments relevant to the project's positioning.
Source: [search query used]]
```

**Version bump rule:**
- Major architectural decision â†’ bump minor (v1.0 â†’ v1.1)
- Clarification or small adjustment â†’ bump patch (v1.0 â†’ v1.0.1)
- Ask yourself: "Would the project's soul recognize itself after this change?"

---

## Phase 6: Done Report

Always show this at the end:

```
[CTX COMPLETE] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Mode:      [full/arch/deps/debt/update/quick/ideology]
Scanned:   X files via Glob
Read:      Y files
Written:   PROJECT_CONTEXT_MAP.md âœ“ (or "not written" for quick modes)
Ideology:  PROJECT_IDEOLOGY.md âœ“ created / âœ“ updated (vX.Y) / â„¹ï¸ no changes (or "skipped" for quick modes)
Tokens:    ~Zk for this analysis

Key insight: [1 most important thing to know about this project right now]

Context loaded. Ready for tasks.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

## Special: Incremental Update Mode (`/ctx update`)

When mode = "update":
1. Read existing `PROJECT_CONTEXT_MAP.md` (full)
2. Run `git log --oneline -10` to see recent changes
3. Run `git diff --name-only HEAD~5 HEAD` to see changed files
4. Read ONLY the changed files (targeted)
5. Update only the relevant sections of the map
6. Note: "Updated X sections based on Y recent commits"
7. **Also run Phase 5 Case B** â€” check if ideology needs a delta append

Cost: ~3-4k tokens instead of 10-15k for full scan.

---

## Honesty Protocol (mandatory)

- âŒ Never fabricate project structure â€” only report what Glob/Read confirmed
- âŒ Never guess complexity score â€” base it on actual file count + signals found
- âŒ Never write ideology from assumptions â€” ground it in README, ROADMAP, git history
- âœ… Think harder before finalizing ideology â€” it's the project's soul, not a summary
- âœ… "I don't know the WHY yet" â†’ ask the user, don't invent it
- âœ… Mark WebSearch results with source and date
- âœ… Mark uncertain claims with [ESTIMATE] or [VERIFY]

---

## Notes on Limitations (be honest with user if asked)

This skill does NOT support:
- Auto-triggering on file changes (not supported in Claude Code)
- Background monitoring
- Real-time architecture drift detection
- VSCode integration beyond standard Claude Code

What it DOES support:
- Manual invocation at any time: `/ctx`
- Incremental updates: `/ctx update`
- Focused scans: `/ctx deps`, `/ctx debt`, `/ctx arch`
- Ideology capture: `/ctx ideology`
- Persistent map in `PROJECT_CONTEXT_MAP.md` for cheap future reference
- Persistent ideology in `PROJECT_IDEOLOGY.md` (append-only)
