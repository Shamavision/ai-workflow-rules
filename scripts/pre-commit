#!/bin/bash
# ==============================================================================
# PRE-COMMIT HOOK - SECRETS SCANNER
# AI Workflow Rules Framework v4.0
# ==============================================================================
#
# PURPOSE:
#   Prevent committing sensitive data to git repository
#
# WHAT IT CHECKS:
#   1. API keys and tokens (OpenAI, Anthropic, AWS, etc.)
#   2. Private keys and certificates (.pem, .key)
#   3. Environment files (.env, .env.local)
#   4. Passwords and credentials
#   5. LANG-CRITICAL violations (russian content) - WARNING
#   6. License keys - BLOCK
#   7. Russian tracking services (Yandex, VK, Mail.ru, etc.) - BLOCK
#
# BEHAVIOR:
#   - âœ… If clean: Commit proceeds
#   - âš ï¸  LANG-CRITICAL: Warning (doesn't block)
#   - âŒ Secrets/Trackers: Commit is BLOCKED
#   - Shows what was found (with alternatives)
#
# BYPASS (emergency only):
#   git commit --no-verify
#   WARNING: Only use if you're absolutely sure!
#
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Flags
SECRETS_FOUND=false
VIOLATIONS_FOUND=false
TRACKERS_FOUND=false

# ==============================================================================
# FUNCTIONS
# ==============================================================================

print_header() {
    echo -e "${BLUE}ğŸ”’ Pre-Commit Security Scan${NC}"
    echo ""
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# ==============================================================================
# PATTERNS TO DETECT
# ==============================================================================

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    print_success "No files staged"
    exit 0
fi

print_header
echo "Scanning $(echo "$STAGED_FILES" | wc -l) staged file(s)..."
echo ""

# ==============================================================================
# CHECK 1: BLOCKED FILE TYPES
# ==============================================================================

echo "â”â”â” Checking for blocked file types..."

BLOCKED_FILES=(
    ".env"
    ".env.local"
    ".env.development"
    ".env.production"
    ".env.test"
    ".ai/license.json"
    "secrets.json"
    "credentials.json"
    ".anthropic"
    ".openai"
)

for file in $STAGED_FILES; do
    filename=$(basename "$file")

    for blocked in "${BLOCKED_FILES[@]}"; do
        if [ "$filename" == "$blocked" ]; then
            print_error "Blocked file: $file"
            echo "   Reason: Contains secrets/credentials"
            echo "   Fix: Unstage this file (git reset HEAD $file)"
            SECRETS_FOUND=true
        fi
    done

    # Check for private keys
    if [[ "$file" =~ \.(pem|key|p12|pfx|cer|crt)$ ]]; then
        print_error "Private key detected: $file"
        echo "   Reason: Cryptographic keys must not be committed"
        echo "   Fix: Unstage this file and add to .gitignore"
        SECRETS_FOUND=true
    fi
done

# ==============================================================================
# CHECK 2: API KEYS & TOKENS (Content Scan)
# ==============================================================================

echo "â”â”â” Scanning file contents for secrets..."

# Patterns for common secrets
SECRET_PATTERNS=(
    # API Keys
    "ANTHROPIC_API_KEY"
    "OPENAI_API_KEY"
    "CLAUDE_API_KEY"
    "sk-ant-api"               # Anthropic key prefix
    "sk-[a-zA-Z0-9]{48}"       # OpenAI key pattern
    "AWS_ACCESS_KEY_ID"
    "AWS_SECRET_ACCESS_KEY"
    "GITHUB_TOKEN"
    "GH_TOKEN"
    "STRIPE_SECRET_KEY"
    "STRIPE_PUBLISHABLE_KEY"

    # Database URLs
    "postgres://.*:.*@"
    "mongodb://.*:.*@"
    "mysql://.*:.*@"

    # Generic patterns
    "password.*=.*['\"][^'\"]{8,}"
    "api[_-]?key.*=.*['\"][^'\"]{16,}"
    "secret.*=.*['\"][^'\"]{16,}"
    "token.*=.*['\"][^'\"]{16,}"

    # Private keys
    "BEGIN RSA PRIVATE KEY"
    "BEGIN PRIVATE KEY"
    "BEGIN OPENSSH PRIVATE KEY"
)

for file in $STAGED_FILES; do
    # Skip binary files
    if file "$file" | grep -q "binary"; then
        continue
    fi

    # Skip node_modules, dist, build
    if [[ "$file" =~ node_modules|dist|build|\.next ]]; then
        continue
    fi

    # Scan file content
    for pattern in "${SECRET_PATTERNS[@]}"; do
        if grep -qiE "$pattern" "$file" 2>/dev/null; then
            # Found potential secret
            line_number=$(grep -inE "$pattern" "$file" | head -n 1 | cut -d: -f1)

            print_error "Potential secret in: $file:$line_number"
            echo "   Pattern matched: $pattern"
            echo "   Fix: Remove secret, use environment variables"

            SECRETS_FOUND=true
        fi
    done
done

# ==============================================================================
# CHECK 3: LANG-CRITICAL VIOLATIONS
# ==============================================================================

echo "â”â”â” Checking for LANG-CRITICAL violations..."

LANG_PATTERNS=(
    '\.ru[^a-z]'              # .ru domains
    'ru-RU'                    # Russian locale
    'ru_RU'
    '"ru"'                     # lang="ru"
    "RUB"                      # Russian currency
    "â‚½"
    '"+7 '                     # Russian phone
    '+7[0-9]{10}'
)

for file in $STAGED_FILES; do
    # Skip binary files
    if file "$file" | grep -q "binary"; then
        continue
    fi

    # Skip node_modules
    if [[ "$file" =~ node_modules ]]; then
        continue
    fi

    for pattern in "${LANG_PATTERNS[@]}"; do
        if grep -qE "$pattern" "$file" 2>/dev/null; then
            line_number=$(grep -nE "$pattern" "$file" | head -n 1 | cut -d: -f1)

            print_error "LANG-CRITICAL violation in: $file:$line_number"
            echo "   Pattern: $pattern (Russian content detected)"
            echo "   Fix: Remove russian content (see RULES_PRODUCT.md Section 3)"

            VIOLATIONS_FOUND=true
        fi
    done
done

# ==============================================================================
# CHECK 4: HARDCODED SECRETS (Common Mistakes)
# ==============================================================================

echo "â”â”â” Checking for hardcoded secrets..."

HARDCODED_PATTERNS=(
    "password\s*=\s*['\"][^'\"]{4,}['\"]"
    "apiKey\s*=\s*['\"][^'\"]{16,}['\"]"
    "secretKey\s*=\s*['\"][^'\"]{16,}['\"]"
    "access_token\s*=\s*['\"][^'\"]{16,}['\"]"
)

for file in $STAGED_FILES; do
    # Skip binary
    if file "$file" | grep -q "binary"; then
        continue
    fi

    # Only check source files
    if [[ ! "$file" =~ \.(js|ts|jsx|tsx|py|go|rb|java|cs)$ ]]; then
        continue
    fi

    for pattern in "${HARDCODED_PATTERNS[@]}"; do
        if grep -qiE "$pattern" "$file" 2>/dev/null; then
            line_number=$(grep -inE "$pattern" "$file" | head -n 1 | cut -d: -f1)

            print_warning "Hardcoded value in: $file:$line_number"
            echo "   Looks like a hardcoded credential"
            echo "   Verify this is not a real secret"

            # Don't block commit for warnings, just inform
        fi
    done
done

# ==============================================================================
# CHECK 5: LICENSE KEYS
# ==============================================================================

echo "â”â”â” Checking for license keys..."

for file in $STAGED_FILES; do
    if file "$file" | grep -q "binary"; then
        continue
    fi

    # Check for AWRF license keys
    if grep -qE "AWRF-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}" "$file" 2>/dev/null; then
        line_number=$(grep -nE "AWRF-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}" "$file" | head -n 1 | cut -d: -f1)

        print_error "License key detected in: $file:$line_number"
        echo "   Reason: License keys must not be committed"
        echo "   Fix: Remove license key, use .ai/license.json (gitignored)"

        SECRETS_FOUND=true
    fi
done

# ==============================================================================
# CHECK 6: RUSSIAN TRACKING SERVICES
# ==============================================================================

echo "â”â”â” Checking for russian tracking services..."

# Whitelist: Don't scan these files (they contain patterns for detection)
TRACKER_WHITELIST=(
    ".ai/forbidden-trackers.json"
    "scripts/seo-check.sh"
    ".git/hooks/pre-commit"
    "RULES_PRODUCT.md"
    "public/robots.txt"
)

# Russian tracking patterns (critical threats)
TRACKER_PATTERNS=(
    "metrika\\.yandex"
    "mc\\.yandex"
    "top\\.mail\\.ru"
    "top-fwz1\\.mail\\.ru"
    "vk\\.com/js/api"
    "vk\\.com/pixel"
    "VK\\.Retargeting"
    "VK\\.Goal"
    "ok\\.ru"
    "ODKL"
    "yastatic\\.net"
    "yandex\\.st"
    "yookassa"
    "kassa\\.yandex"
    "money\\.yandex"
    "qiwi\\."
    "webmoney"
    "api-maps\\.yandex"
    "ymaps"
    "2gis"
    "rutube\\.ru"
    "vk.*video"
    "wildberries"
    "wbstatic"
    "ozon\\.ru"
    "rambler.*counter"
    "liveinternet"
    "counter\\.yadro"
)

for file in $STAGED_FILES; do
    # Skip binary files
    if file "$file" | grep -q "binary"; then
        continue
    fi

    # Skip node_modules
    if [[ "$file" =~ node_modules ]]; then
        continue
    fi

    # Skip whitelisted files
    skip=false
    for whitelist_file in "${TRACKER_WHITELIST[@]}"; do
        if [[ "$file" == *"$whitelist_file"* ]]; then
            skip=true
            break
        fi
    done

    if [ "$skip" == "true" ]; then
        continue
    fi

    # Scan for russian trackers
    for pattern in "${TRACKER_PATTERNS[@]}"; do
        if grep -qiE "$pattern" "$file" 2>/dev/null; then
            line_number=$(grep -inE "$pattern" "$file" | head -n 1 | cut -d: -f1)

            print_error "RUSSIAN TRACKER detected in: $file:$line_number"
            echo "   Pattern: $pattern"
            echo "   Threat: Data sent to russian servers (security + legal risk)"
            echo ""
            echo "   Safe alternatives:"
            echo "     Analytics: Google Analytics, Plausible, Matomo"
            echo "     Social: Facebook Pixel, LinkedIn Insight Tag"
            echo "     Payments: Stripe, PayPal, WayForPay (UA), LiqPay (UA)"
            echo "     CDN: Cloudflare, jsDelivr, unpkg"
            echo ""
            echo "   See: .ai/forbidden-trackers.json for full list"
            echo ""

            TRACKERS_FOUND=true
        fi
    done
done

# ==============================================================================
# FINAL VERDICT
# ==============================================================================

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# LANG-CRITICAL = WARNING (doesn't block)
if [ "$VIOLATIONS_FOUND" == "true" ]; then
    echo -e "${YELLOW}âš ï¸  LANG-CRITICAL WARNINGS DETECTED${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Russian content patterns detected in your commit."
    echo ""
    echo "Review findings above:"
    echo "  â€¢ If legitimate (examples, detection patterns, names): proceed"
    echo "  â€¢ If actual violation (production code): fix before commit"
    echo ""
    echo "Context-aware exceptions:"
    echo "  âœ… Security tools (scripts/seo-check.sh, pre-commit)"
    echo "  âœ… Documentation examples"
    echo "  âœ… Historical data in mock files"
    echo "  âœ… Ukrainian/Russian names (Ğ†Ğ²Ğ°Ğ½Ğ¾Ğ²/Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²)"
    echo ""
    echo "See RULES_PRODUCT.md Section 7.12 for flexible policy."
    echo ""
    echo -e "${YELLOW}Commit will PROCEED (this is a warning, not an error)${NC}"
    echo ""
fi

# SECRETS = BLOCK (critical)
if [ "$SECRETS_FOUND" == "true" ]; then
    echo -e "${RED}âŒ COMMIT BLOCKED - SECRETS DETECTED!${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸš¨ Your commit contains sensitive data that must not be pushed."
    echo ""
    echo "To fix:"
    echo "  1. Remove secrets from files"
    echo "  2. Use environment variables (process.env.VAR)"
    echo "  3. Add sensitive files to .gitignore"
    echo "  4. Unstage with: git reset HEAD <file>"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Bypass (emergency only): git commit --no-verify"
    echo "âš ï¸  Only use if you're ABSOLUTELY SURE files are safe!"
    echo ""

    exit 1
fi

# RUSSIAN TRACKERS = BLOCK (critical security threat)
if [ "$TRACKERS_FOUND" == "true" ]; then
    echo -e "${RED}âŒ COMMIT BLOCKED - RUSSIAN TRACKERS DETECTED!${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸš¨ Your commit contains russian tracking services."
    echo ""
    echo "Security threat:"
    echo "  â€¢ User data sent to russian state servers"
    echo "  â€¢ Potential FSB/GRU surveillance"
    echo "  â€¢ GDPR violations"
    echo "  â€¢ Sanctions risk"
    echo "  â€¢ Legal liability for Ukrainian businesses"
    echo ""
    echo "To fix:"
    echo "  1. Remove russian tracking scripts (see errors above)"
    echo "  2. Replace with safe alternatives (Google Analytics, Plausible, etc.)"
    echo "  3. See .ai/forbidden-trackers.json for full migration guide"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Bypass (emergency only): git commit --no-verify"
    echo "âš ï¸  Only use if tracker is for testing/demo purposes!"
    echo ""

    exit 1
fi

# All clear
if [ "$SECRETS_FOUND" == "false" ] && [ "$VIOLATIONS_FOUND" == "false" ] && [ "$TRACKERS_FOUND" == "false" ]; then
    echo -e "${GREEN}âœ… SECURITY SCAN PASSED${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    print_success "No secrets, violations, or russian trackers detected"
    echo ""
fi

echo "Proceeding with commit..."
echo ""
exit 0
